TOOLS_DIR = ../../tools
TECHMAP_DIR = ../../techmap/redlogic
YOSYS = $(TOOLS_DIR)/yosys
EDIF2XML = $(TOOLS_DIR)/edif2xml
PLACER = $(TOOLS_DIR)/placer
ROUTER = $(TOOLS_DIR)/router
SLICER = $(TOOLS_DIR)/slicer

YOSYS_SCRIPT = script.ys
PLACER_JOB_FILE = placer_job.xml
ROUTER_JOB_FILE = router_job.xml
SLICER_JOB_FILE = slicer_job.xml
VARIANTS_FILE = vars.xml

NETLIST_FILE = synth.edif
NETLIST_XML_FILE = netlist.xml
PLACER_RESULT_FILE = placement.xml
ROUTER_RESULT_FILE = result.xml
SLICER_RESULT_FILE = result.gcode

all: $(SLICER_RESULT_FILE)

$(NETLIST_FILE):
	$(YOSYS) $(YOSYS_SCRIPT)

$(NETLIST_XML_FILE): $(NETLIST_FILE)
	$(EDIF2XML) $(NETLIST_FILE) $(NETLIST_XML_FILE)

$(PLACER_RESULT_FILE): $(NETLIST_XML_FILE) $(PLACER_JOB_FILE) $(VARIANTS_FILE)
	$(PLACER) $(NETLIST_XML_FILE) $(PLACER_JOB_FILE) $(VARIANTS_FILE) $(PLACER_RESULT_FILE)

$(ROUTER_RESULT_FILE): $(PLACER_RESULT_FILE) $(ROUTER_JOB_FILE)
	$(ROUTER) $(PLACER_RESULT_FILE) $(ROUTER_JOB_FILE) $(ROUTER_RESULT_FILE)

$(SLICER_RESULT_FILE): $(ROUTER_RESULT_FILE) $(SLICER_JOB_FILE)
	$(SLICER) $(ROUTER_RESULT_FILE) $(SLICER_JOB_FILE) $(SLICER_RESULT_FILE)

$(VARIANTS_FILE):
	python2 $(TECHMAP_DIR)/gen_variants.py $(VARIANTS_FILE)

clean:
	rm -f $(NETLIST_FILE) $(NETLIST_XML_FILE) $(PLACER_RESULT_FILE) $(ROUTER_RESULT_FILE) $(SLICER_RESULT_FILE)

